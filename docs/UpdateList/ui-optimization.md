# UI 模块优化建议（2026-01-29）

> 说明：基于当前 UI 系统实现给出可执行优化方向，按影响面优先级排序。

## 1. 布局脏区合并

- 现状：每个脏实体都会重建子树并调用 `YGNodeRemoveAllChildren`。
- 建议：仅重算包含脏节点的根树，并对子节点做差量同步。
- 目标：减少大树重建与 Yoga 计算成本。

## 2. Yoga 节点配置缓存

- 现状：`configureYogaNode()` 每次写完整样式。
- 建议：只在组件变更时更新对应字段（尺寸策略、Padding、Alignment 等）。
- 目标：减少 Yoga API 调用与样式重复写入。

## 3. ScrollArea 内容尺寸计算优化

- 现状：每次递归都统计边界。
- 建议：引入 `contentDirty` 标记，内容未变则跳过统计。
- 目标：降低滚动区域内容尺寸计算的额外开销。

## 4. 渲染批次内存复用

- 现状：每帧构建批次 `std::vector`，分配频繁。
- 建议：使用帧内复用缓存或线性分配器。
- 目标：降低分配/释放开销与内存碎片。

## 5. 渲染系统拆分

- 现状：`RenderSystem` 体量过大，职责混杂。
- 建议：拆分为 `DeviceManager`、`PipelineCache`、`TextAtlas`、`Batcher` 等子模块。
- 目标：降低维护成本，提升可读性与测试性。

## 6. 命中测试缓存

- 现状：输入事件会扫描并排序全部可交互实体。
- 建议：按窗口维护 z-order 缓存，层级变化时失效。
- 目标：减少每次输入处理的排序开销。

## 7. 绝对坐标缓存

- 现状：`getAbsolutePosition()` 每次从子到根遍历。
- 建议：布局回写阶段缓存绝对坐标，命中测试直接读取。
- 目标：避免重复遍历。

## 8. 渲染触发去抖

- 现状：每个输入事件都触发 `UpdateRendering`。
- 建议：一帧内合并触发，或采用 render-dirty 聚合。
- 目标：避免重复渲染请求。

## 9. 状态更新合并

- 现状：`StateSystem` 频繁移除/添加标签。
- 建议：同帧内合并 Hover/Active/Focus 更新。
- 目标：减少无效的 Registry 操作。

## 10. 小问题清理

- `getWindowSize()` 内存在不可达返回语句，建议清理。

---
如需我进一步落地某项优化，请标注优先级。
